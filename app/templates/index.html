<!DOCTYPE html>
<html lang="ru" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –õ–∏—Ü–µ–π 22</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <style>
        /* Base styles */
        html, body {
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        body {
            color: #e2e8f0;
            /* NEW SOLUTION: The gradient now scrolls with the content.
               It covers the entire body length, making it look uniform and avoiding mobile browser bugs. */
            background: linear-gradient(135deg, #0f172a, #1e293b, #334155);
        }

        #live-time-portrait,
        #live-time-landscape {
            font-variant-numeric: tabular-nums;
        }

        /* --- Mode switcher --- */
        .landscape-view { display: block; }
        .portrait-view { display: none; } /* Default state: hidden */

        @media (orientation: portrait) {
            .landscape-view { display: none; }
            .portrait-view { display: flex; } /* Becomes a flex container ONLY in portrait mode */
        }

        /* --- Portrait Mode Styles --- */
        .portrait-view {
             flex-direction: column;
             min-height: 100vh;
             box-sizing: border-box;
             padding-top: calc(3rem + env(safe-area-inset-top));
             padding-left: env(safe-area-inset-left);
             padding-right: env(safe-area-inset-right);
             transition: padding-top 0.3s ease;
        }

        .portrait-view .container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .portrait-view .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .portrait-view .logo-img {
            max-width: 240px;
            height: auto;
            opacity: 0.9;
            flex-shrink: 0;
        }
        .portrait-view .header-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-weight: bold;
            color: #cbd5e1;
            text-align: right;
            font-size: 2.2rem;
            line-height: 1.4;
        }

        /* --- Selection Footer Panel --- */
        .selection-footer {
            position: fixed;
            bottom: calc(0.5rem + env(safe-area-inset-bottom));
            left: calc(1rem + env(safe-area-inset-left));
            right: calc(1rem + env(safe-area-inset-right));
            z-index: 1010;
            background-color: rgba(20, 30, 48, 0.75);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.9rem 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.2);
            max-width: 650px;
            margin: 0 auto;
            transform: translateX(0);
        }
         @media (min-width: 576px) {
            .selection-footer {
                left: 50%;
                transform: translateX(-50%);
                width: calc(100% - 2rem);
            }
        }

        /* --- Central Prompt Styles --- */
        #schedule-display {
            position: relative;
        }

        #schedule-display.is-prompting {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .initial-prompt {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: #64748b;
            padding: 2rem;
        }
        .prompt-icon {
            font-size: 4rem;
            line-height: 1;
            margin-bottom: 1rem;
        }
        .initial-prompt h3 {
            color: #cbd5e1;
            font-weight: bold;
        }

        /* --- Schedule Card Styles --- */
        .schedule-day-card {
            background-color: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
        }
        .schedule-day-header {
            font-size: 1.5rem;
            font-weight: bold;
            padding: 0.70rem 1.25rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        .portrait-view .table {
            --bs-table-bg: transparent;
            --bs-table-striped-bg: rgba(255, 255, 255, 0.03);
            --bs-table-border-color: transparent;
        }
        .portrait-view .table td, .portrait-view .table th {
            vertical-align: middle;
        }
        .portrait-view .lesson-num-col { width: 10%; text-align: center; }
        .portrait-view .time-col { width: 30%; text-align: center; }

        /* HIDE HEADER AND REMOVE PADDING ON SMALL SCREENS (PORTRAIT) WHEN SCHEDULE IS SELECTED */
        @media (max-width: 750px) {
            .portrait-view.schedule-selected .header {
                display: none;
            }
            .portrait-view.schedule-selected {
                padding-top: calc(1rem + env(safe-area-inset-top)); /* Reduce padding when header is hidden */
            }
        }

        /* --- Mobile Portrait Specifics --- */
        @media (max-width: 576px) and (orientation: portrait) {
            html {
                font-size: 14px;
            }
            .portrait-view .logo-img {
                max-width: 180px;
            }

            .portrait-view .header {
                justify-content: center;
            }
            .portrait-view .header-info {
                display: none;
            }

            .selection-footer .form-label {
                font-size: 0.8rem;
            }
            .selection-footer .form-select,
            .selection-footer .btn {
                font-size: 0.9rem;
                padding-top: 0.6rem;
                padding-bottom: 0.6rem;
            }
            .content-spacer {
                height: calc(8rem + env(safe-area-inset-bottom));
            }
        }

        /* --- Landscape Mode Styles (Large Version) --- */
        .landscape-view {
            padding: 1.5rem;
            padding-top: calc(2.0rem + env(safe-area-inset-top));
            padding-left: calc(1.5rem + env(safe-area-inset-left));
            padding-right: calc(1.5rem + env(safe-area-inset-right));
            box-sizing: border-box;
        }

        .landscape-view .header-info-simple {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 4.5rem;
            font-weight: bold;
            color: #cbd5e1;
            margin-bottom: -3rem;
        }

        .landscape-view .logo-img-landscape {
            max-height: 100px;
            height: auto;
            opacity: 0.9;
        }
        .landscape-view .header-datetime-landscape {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-size: 2.5rem;
            line-height: 1.3;
        }

        .landscape-view .main-title {
            font-weight: bold;
            margin-bottom: 1.4rem !important;
            font-size: 4rem;
            text-align: center;
        }

        .grade-pair-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 1.5rem;
            min-height: 70vh;
        }

        .grade-pair-container .card {
            background-color: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(200px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .grade-pair-container .card-header {
            background-color: rgba(30, 41, 59, 0.8);
            font-weight: bold;
            padding: 0.75rem 1.25rem;
        }
        .grade-pair-container .card-body {
            padding: 0;
            overflow-x: auto;
        }

        .landscape-view .table {
            table-layout: fixed;
            width: 100%;
            --bs-table-bg: transparent;
            --bs-table-striped-bg: rgba(255, 255, 255, 0.03);
            --bs-table-border-color: rgba(255, 255, 255, 0.1);
        }
        .landscape-view .table td,
        .landscape-view .table th {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* HIDE HEADER ON SMALL SCREENS (LANDSCAPE) */
        @media (max-height: 500px) and (orientation: landscape) {
            .landscape-view .header-info-simple {
                display: none;
            }
            .landscape-view .main-title {
                display: none;
            }
            .landscape-view {
                padding: 1rem;
            }
            html {
                font-size: 13px;
            }
        }

        /* --- Highlight Styles --- */
        .current-lesson {
            background-color: rgba(53, 230, 118, 0.2) !important;
            border-left: 4px solid #33a15c !important;
            border-right: 4px solid #33a15c !important;
        }
        .next-lesson {
            background-color: rgba(137, 132, 219, 0.15) !important;
            border-left: 4px solid #5d5a8f !important;
            border-right: 4px solid #5d5a8f !important;
        }

        /* --- Help Icon --- */
        .prompt-help {
            text-align: center;
            margin-top: 1.5rem;
        }

        .help-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(71, 85, 105, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #cbd5e1;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .help-button:hover {
            background-color: rgba(100, 116, 139, 0.8);
            transform: scale(1.1);
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background-color: #1e293b;
            padding: 2rem;
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 650px;
            width: calc(100% - 2rem);
            position: relative;
            color: #cbd5e1;
        }

        .modal-close {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 2rem;
            color: #94a3b8;
            cursor: pointer;
            line-height: 1;
        }
        .modal-content h4 {
            font-weight: bold;
            margin-bottom: 1rem;
            color: #e2e8f0;
        }
        .modal-content hr {
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* --- Legend Styles --- */
        .legend-list {
            list-style: none;
            padding-left: 0;
            margin-top: 1rem;
        }
        .legend-list li {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
        }
        .legend-color.current {
            background-color: rgba(53, 230, 118, 0.4);
            border: 1px solid #33a15c;
        }
        .legend-color.next {
            background-color: rgba(137, 132, 219, 0.3);
            border: 1px solid #5d5a8f;
        }

        /* --- Hide help icon when schedule is shown --- */
        .portrait-view.schedule-selected .initial-prompt,
        .portrait-view.schedule-selected .prompt-help {
            display: none;
        }
    </style>

</head>
<body>
    <div class="portrait-view">
        <div class="container">
            <header class="header">
                {% if logo_path %}
                    <img src="{{ url_for('static', filename=logo_path) }}" alt="–õ–æ–≥–æ—Ç–∏–ø" class="logo-img">
                {% endif %}
                <div class="header-info">
                    <span id="current-date-portrait">{{ current_date }}</span>
                    <span id="live-time-portrait">00:00:00</span>
                </div>
            </header>

            <div id="schedule-display" class="is-prompting">
                 <div class="initial-prompt">
                    <div class="prompt-icon">üìÖ</div>
                    <h3>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ</h3>
                    <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞–Ω–µ–ª—å –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –∫–ª–∞—Å—Å</p>
                    <div class="prompt-help">
                        <button id="help-icon" class="help-button" aria-label="–ü–æ–º–æ—â—å">?</button>
                    </div>
                </div>
            </div>

            <div class="content-spacer"></div>
        </div>

        <div class="selection-footer">
            <div id="selection-container">
                <div class="row g-2 align-items-end">
                    <div class="col">
                        <label for="grade-selector" class="form-label">–ü–∞—Ä–∞–ª–ª–µ–ª—å</label>
                        <select id="grade-selector" class="form-select form-select-lg" autocomplete="off">
                            <option selected disabled>--</option>
                        </select>
                    </div>
                    <div class="col">
                        <label for="class-selector" class="form-label">–ö–ª–∞—Å—Å</label>
                        <select id="class-selector" class="form-select form-select-lg" disabled autocomplete="off">
                            <option selected disabled>--</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <button id="reset-button" class="btn btn-secondary btn-lg w-100">–°–±—Ä–æ—Å</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="landscape-view">
        <div class="container-fluid">
            <div class="header-info-simple">
                {% if logo_path %}
                    <img src="{{ url_for('static', filename=logo_path) }}" alt="–õ–æ–≥–æ—Ç–∏–ø" class="logo-img-landscape">
                {% endif %}
                <div class="header-datetime-landscape">
                    <span id="current-date-landscape">{{ current_date }}</span>
                    <span id="live-time-landscape">00:00:00</span>
                </div>
            </div>

            {% if schedule_for_today and active_day_name %}
                <h1 class="main-title">{{ active_day_name }}</h1>
                {% if schedule_for_today.landscape_slides and schedule_for_today.landscape_slides|length > 0 %}
                    <div id="scheduleCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-pause="false" data-bs-interval="{{ carousel_interval * 1000 }}">
                        <div class="carousel-inner">

                            {% for slide_group in schedule_for_today.landscape_slides %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <div class="grade-pair-container">
                                        {% for grade_data in slide_group %}
                                            <div class="card">
                                                <div class="card-header"><h4 class="m-0 text-center">{{ grade_data.grade_key }}</h4></div>
                                                <div class="card-body">
                                                    <div class="table-responsive">
                                                        <table class="table table-bordered table-striped mb-0">
                                                            <thead>
                                                                <tr>
                                                                    <th style="width: 3%;" class="text-center">‚Ññ</th>
                                                                    <th style="width: 7%;" class="text-center">–í—Ä–µ–º—è</th>
                                                                    {% for class_name in grade_data.class_names %}
                                                                        <th>{{ class_name }}</th>
                                                                    {% endfor %}
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {% for row in grade_data.schedule_rows %}
                                                                <tr data-time-start="{{ row['–≤—Ä–µ–º—è'] }}">
                                                                    <td class="text-center">{{ row['—É—Ä–æ–∫'] }}</td>
                                                                    <td class="text-center">{{ row['–≤—Ä–µ–º—è'] }}</td>
                                                                    {% for class_name in grade_data.class_names %}
                                                                        <td>{{ row.–ø—Ä–µ–¥–º–µ—Ç—ã.get(class_name, '') }}</td>
                                                                    {% endfor %}
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% elif lessons_are_over %}
                    <div class="alert alert-primary text-center mt-4"><h4>–°–µ–π—á–∞—Å –∑–∞–Ω—è—Ç–∏–π –Ω–µ—Ç.</h4></div>
                {% else %}
                    <div class="alert alert-info text-center mt-4"><h4>–ó–∞–Ω—è—Ç–∏–π —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç.</h4></div>
                {% endif %}
            {% elif is_weekend %}
                <h1 class="main-title">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</h1>
                <div class="alert alert-info text-center mt-4"><h4>–°–µ–≥–æ–¥–Ω—è –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å!</h4></div>
            {% else %}
                <div class="alert alert-warning text-center mt-4" role="alert">–ù–∞ —Å–µ–≥–æ–¥–Ω—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–µ—Ç –∏–ª–∏ –æ–Ω–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ.</div>
            {% endif %}
        </div>
    </div>


    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script>
        const fullSchedule = {{ full_schedule | tojson }};
        const activeDayName = '{{ active_day_name }}';

        const gradeSelector = document.getElementById('grade-selector');
        const classSelector = document.getElementById('class-selector');
        const scheduleDisplay = document.getElementById('schedule-display');
        const resetButton = document.getElementById('reset-button');
        const portraitView = document.querySelector('.portrait-view');

        const initialScheduleDisplayHTML = scheduleDisplay.innerHTML;

        // ++ NEW: Keys for localStorage
        const STORAGE_KEY_GRADE = 'selectedGrade';
        const STORAGE_KEY_CLASS = 'selectedClass';

        function isMobileDevice() {
            // A simple check for mobile devices based on user agent
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        if (gradeSelector) {
            function populateGradeSelector() {
                const grades = new Set();
                if (fullSchedule) {
                    for (const day in fullSchedule) {
                        if (fullSchedule[day] && fullSchedule[day].portrait_view) {
                            for (const className in fullSchedule[day].portrait_view) {
                                const gradeMatch = className.match(/^\d+/);
                                if (gradeMatch) grades.add(gradeMatch[0]);
                            }
                        }
                    }
                }
                Array.from(grades).sort((a, b) => parseInt(a) - parseInt(b)).forEach(grade => {
                    const option = new Option(`${grade}-–µ –∫–ª–∞—Å—Å—ã`, grade);
                    gradeSelector.add(option);
                });
            }

            function populateClassSelector(selectedGrade) {
                classSelector.innerHTML = '<option selected disabled>--</option>';
                classSelector.disabled = true;
                if (!selectedGrade || !fullSchedule) return;

                const classNames = new Set();
                for (const day in fullSchedule) {
                     if (fullSchedule[day] && fullSchedule[day].portrait_view) {
                        for (const className in fullSchedule[day].portrait_view) {
                            if (className.startsWith(selectedGrade + ' ')) {
                                classNames.add(className);
                            }
                        }
                    }
                }
                Array.from(classNames).sort().forEach(name => {
                    const option = new Option(name, name);
                    classSelector.add(option);
                });
                classSelector.disabled = false;
            }

            function displayWeekSchedule(selectedClass) {
                if (!selectedClass) {
                    scheduleDisplay.innerHTML = initialScheduleDisplayHTML;
                    scheduleDisplay.classList.add('is-prompting');
                    if (portraitView) portraitView.classList.remove('schedule-selected');
                    initializeModalHandlers(); // Re-initialize listeners for the new elements
                    return;
                }

                if (portraitView) portraitView.classList.add('schedule-selected');
                scheduleDisplay.classList.remove('is-prompting');
                let html = '<div class="row g-4">';
                const daysOrder = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞"];

                for (const day of daysOrder) {
                    const dayData = fullSchedule[day]?.portrait_view[selectedClass];
                    html += `<div class="col-12 col-lg-6"><div id="day-${day}" class="schedule-day-card">`;
                    html += `<div class="schedule-day-header">${day}</div>`;
                    if (dayData && dayData.lessons.some(l => l.–ø—Ä–µ–¥–º–µ—Ç !== '‚Äî')) {
                        html += '<table class="table table-striped mb-0">';
                        html += `<thead><tr><th class="lesson-num-col">‚Ññ</th><th class="time-col">–í—Ä–µ–º—è</th><th>–ü—Ä–µ–¥–º–µ—Ç</th></tr></thead><tbody>`;
                        dayData.lessons.forEach(lesson => {
                            html += `<tr data-time-start="${lesson.–≤—Ä–µ–º—è}"><td class="lesson-num-col">${lesson.—É—Ä–æ–∫}</td><td class="time-col">${lesson.–≤—Ä–µ–º—è}</td><td>${lesson.–ø—Ä–µ–¥–º–µ—Ç}</td></tr>`;
                        });
                        html += '</tbody></table>';
                    } else {
                        html += '<div class="p-4 text-center">–í —ç—Ç–æ—Ç –¥–µ–Ω—å –∑–∞–Ω—è—Ç–∏–π –Ω–µ—Ç.</div>';
                    }
                    html += '</div></div>';
                }
                html += '</div>';
                scheduleDisplay.innerHTML = html;
                highlightCurrentLesson();

                setTimeout(() => {
                    const todayCard = document.getElementById(`day-${activeDayName}`);
                    if (todayCard) {
                        todayCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }

            gradeSelector.addEventListener('change', (e) => {
                populateClassSelector(e.target.value);
                classSelector.selectedIndex = 0;
                displayWeekSchedule(null);
                if (isMobileDevice()) {
                    localStorage.removeItem(STORAGE_KEY_CLASS);
                    localStorage.setItem(STORAGE_KEY_GRADE, e.target.value);
                }
            });

            classSelector.addEventListener('change', (e) => {
                const selectedClass = e.target.value;
                displayWeekSchedule(selectedClass);
                if (isMobileDevice()) {
                    localStorage.setItem(STORAGE_KEY_GRADE, gradeSelector.value);
                    localStorage.setItem(STORAGE_KEY_CLASS, selectedClass);
                }
            });

            resetButton.addEventListener('click', () => {
                gradeSelector.selectedIndex = 0;
                classSelector.innerHTML = '<option selected disabled>--</option>';
                classSelector.disabled = true;
                displayWeekSchedule(null);
                if (isMobileDevice()) {
                    localStorage.removeItem(STORAGE_KEY_GRADE);
                    localStorage.removeItem(STORAGE_KEY_CLASS);
                }
            });

            populateGradeSelector();
        }

        const serverTimeString = '{{ current_time }}';
        let [hours, minutes, seconds] = serverTimeString.split(':').map(Number);

        const timePortrait = document.getElementById('live-time-portrait');
        const timeLandscape = document.getElementById('live-time-landscape');

        function parseTimeToMinutes(timeStr) {
            if (!timeStr || typeof timeStr !== 'string') return null;
            const match = timeStr.match(/(\d{1,2})[.:](\d{2})/);
            if (match) {
                const h = parseInt(match[1], 10);
                const m = parseInt(match[2], 10);
                if (!isNaN(h) && !isNaN(m)) return h * 60 + m;
            }
            return null;
        }

        function highlightCurrentLesson() {
            const LESSON_DURATION_MIN = 40;
            const currentTotalMinutes = hours * 60 + minutes;

            const processTable = (table) => {
                const lessonRows = Array.from(table.querySelectorAll('tbody tr[data-time-start]'));
                const lessons = lessonRows
                    .map(row => ({
                        element: row,
                        startMinutes: parseTimeToMinutes(row.dataset.timeStart)
                    }))
                    .filter(lesson => lesson.startMinutes !== null)
                    .sort((a, b) => a.startMinutes - b.startMinutes);

                lessons.forEach(lesson => lesson.element.classList.remove('current-lesson', 'next-lesson'));

                let currentLessonFound = false;
                for (const lesson of lessons) {
                    const endMinutes = lesson.startMinutes + LESSON_DURATION_MIN;
                    if (currentTotalMinutes >= lesson.startMinutes && currentTotalMinutes < endMinutes) {
                        lesson.element.classList.add('current-lesson');
                        currentLessonFound = true;
                        break;
                    }
                }

                if (!currentLessonFound) {
                    for (const lesson of lessons) {
                        if (lesson.startMinutes > currentTotalMinutes) {
                            lesson.element.classList.add('next-lesson');
                            break;
                        }
                    }
                }
            };

            document.querySelectorAll('#scheduleCarousel table').forEach(processTable);

            document.querySelectorAll('.schedule-day-card').forEach(card => {
                const header = card.querySelector('.schedule-day-header');
                if (header && header.textContent.trim() === activeDayName) {
                    const table = card.querySelector('table');
                    if (table) processTable(table);
                }
            });
        }

        function updateClock() {
            seconds++;
            if (seconds >= 60) {
                seconds = 0; minutes++;
                if (minutes >= 60) {
                    minutes = 0; hours++;
                    if (hours >= 24) hours = 0;
                }
            }

            const fHours = String(hours).padStart(2, '0');
            const fMinutes = String(minutes).padStart(2, '0');
            const fSeconds = String(seconds).padStart(2, '0');
            const timeString = `${fHours}:${fMinutes}:${fSeconds}`;

            if (timePortrait) timePortrait.textContent = timeString;
            if (timeLandscape) timeLandscape.textContent = timeString;

            highlightCurrentLesson();
        }

        // Set an interval to reload the page to fetch new schedule data
        setInterval(() => { window.location.reload(true); }, {{ refresh_interval }} * 1000);

        window.addEventListener('DOMContentLoaded', () => {
            updateClock(); // Run clock once immediately
            setInterval(updateClock, 1000); // Then update every second

            if (isMobileDevice()) {
                const savedGrade = localStorage.getItem(STORAGE_KEY_GRADE);
                const savedClass = localStorage.getItem(STORAGE_KEY_CLASS);

                if (savedGrade) {
                    gradeSelector.value = savedGrade;
                    populateClassSelector(savedGrade);
                    if (savedClass) {
                        classSelector.value = savedClass;
                        displayWeekSchedule(savedClass);
                    }
                }
            }
            initializeModalHandlers(); // Initialize handlers on page load
        });

        // --- Modal Logic ---
        function initializeModalHandlers() {
            const helpIcon = document.getElementById('help-icon');
            const helpModal = document.getElementById('help-modal');
            const closeModal = document.getElementById('close-modal');

            if (helpIcon && helpModal && closeModal) {
                helpIcon.addEventListener('click', () => {
                    helpModal.style.display = 'flex';
                });

                closeModal.addEventListener('click', () => {
                    helpModal.style.display = 'none';
                });

                // Close modal if user clicks on the overlay
                helpModal.addEventListener('click', (e) => {
                    if (e.target === helpModal) {
                        helpModal.style.display = 'none';
                    }
                });
            }
        }
    </script>
    <div id="help-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button id="close-modal" class="modal-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
            <h4>–ü–æ–¥—Å–∫–∞–∑–∫–∞</h4>
            <p>–í–∞—à –≤—ã–±–æ—Ä –∫–ª–∞—Å—Å–∞ –∏ –ø–∞—Ä–∞–ª–ª–µ–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ö–æ–≥–¥–∞ –≤—ã –æ—Ç–∫—Ä–æ–µ—Ç–µ —Å–∞–π—Ç –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è —Å—Ä–∞–∑—É.</p>
            <p>–ö–Ω–æ–ø–∫–∞ "–°–±—Ä–æ—Å" –æ—á–∏—â–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä.</p>
            <hr>
            <p><strong>–û–±–æ–∑–Ω–∞—á–µ–Ω–∏—è —É—Ä–æ–∫–æ–≤:</strong></p>
            <ul class="legend-list">
                <li><span class="legend-color current"></span> ‚Äî —Ç–µ–∫—É—â–∏–π —É—Ä–æ–∫</li>
                <li><span class="legend-color next"></span> ‚Äî —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫</li>
            </ul>
        </div>
    </div>
</body>
</html>

