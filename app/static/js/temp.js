

    // --- ОСТАЛЬНЫЕ ФУНКЦИИ (без изменений) ---
    function populateGradeSelector() { const grades = new Set(); Object.values(fullSchedule).forEach(day => { if (day?.portrait_view) Object.keys(day.portrait_view).forEach(className => { const gradeMatch = className.match(/^\d+/); if (gradeMatch) grades.add(gradeMatch[0]); }); }); Array.from(grades).sort((a, b) => parseInt(a) - parseInt(b)).forEach(grade => gradeSelector.add(new Option(`${grade}-е классы`, grade))); }
    function populateClassSelector(selectedGrade) { classSelector.innerHTML = '<option selected disabled>--</option>'; classSelector.disabled = true; if (!selectedGrade) return; const classNames = new Set(); Object.values(fullSchedule).forEach(day => { if (day?.portrait_view) Object.keys(day.portrait_view).forEach(className => { if (className.startsWith(selectedGrade + ' ')) classNames.add(className); }); }); Array.from(classNames).sort().forEach(name => classSelector.add(new Option(name, name))); classSelector.disabled = false; }
    function handleGradeChange(e) { populateClassSelector(e.target.value); classSelector.selectedIndex = 0; displayWeekSchedule(null); if (isMobileDevice()) { localStorage.removeItem(STORAGE_KEY_CLASS); localStorage.setItem(STORAGE_KEY_GRADE, e.target.value); } }
    function handleClassChange(e) { const selectedClass = e.target.value; displayWeekSchedule(selectedClass); if (isMobileDevice()) { localStorage.setItem(STORAGE_KEY_GRADE, gradeSelector.value); localStorage.setItem(STORAGE_KEY_CLASS, selectedClass); } }
    function handleReset() { clearTimeout(inactivityTimer); gradeSelector.selectedIndex = 0; classSelector.innerHTML = '<option selected disabled>--</option>'; classSelector.disabled = true; displayWeekSchedule(null); if (isMobileDevice()) { localStorage.removeItem(STORAGE_KEY_GRADE); localStorage.removeItem(STORAGE_KEY_CLASS); } }
    function setupClock() { const serverTimeParts = currentTime.split(':').map(Number); const serverDate = new Date(); serverDate.setHours(serverTimeParts[0], serverTimeParts[1], serverTimeParts[2]); timeDifference = serverDate.getTime() - new Date().getTime(); updateClock(); setInterval(updateClock, 1000); }
    function updateClock() { const correctedDate = new Date(new Date().getTime() + timeDifference); hours = correctedDate.getHours(); minutes = correctedDate.getMinutes(); seconds = correctedDate.getSeconds(); const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; if (portraitView.style.display !== 'none') document.getElementById('live-time-portrait').textContent = timeString; if (timeLandscape && timeLandscape.style.display !== 'none') document.getElementById('live-time-landscape').textContent = timeString; highlightCurrentItems(); }
    function highlightCurrentItems() { const currentTotalMinutes = hours * 60 + minutes; const applyHighlighting = (selector) => { const elements = Array.from(document.querySelectorAll(selector)); if (elements.length === 0) return; elements.forEach(el => el.classList.remove('current-lesson', 'next-lesson')); const items = elements.map(el => ({ element: el, startMinutes: parseTimeToMinutes(el.dataset.timeStart), endMinutes: parseTimeToMinutes(el.dataset.timeEnd) })).filter(item => item.startMinutes !== null && item.endMinutes !== null); items.forEach(item => { if (currentTotalMinutes >= item.startMinutes && currentTotalMinutes < item.endMinutes) { item.element.classList.add('current-lesson'); } }); let nextStartTime = Infinity; items.forEach(item => { if (item.startMinutes > currentTotalMinutes) { if (item.startMinutes < nextStartTime) { nextStartTime = item.startMinutes; } } }); if (nextStartTime !== Infinity) { items.forEach(item => { if (item.startMinutes === nextStartTime) { item.element.classList.add('next-lesson'); } }); } }; applyHighlighting('#scheduleCarousel tr[data-time-start], #day-' + activeDayName + ' tr[data-time-start], #consultation-list-display tr[data-time-start]'); }
    function isMobileDevice() { return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent); }
    function parseTimeToMinutes(timeStr) { if (!timeStr || typeof timeStr !== 'string') return null; const match = timeStr.match(/(\d{1,2})[.:](\d{2})/); return match ? parseInt(match[1], 10) * 60 + parseInt(match[2], 10) : null; }
    function initializeModalHandlers() { const helpIcon = document.querySelector('.prompt-help .help-button'); const helpModal = document.getElementById('help-modal'); const closeModal = document.getElementById('close-modal'); if (helpIcon && helpModal && closeModal) { helpIcon.addEventListener('click', () => { helpModal.style.display = 'flex'; }); closeModal.addEventListener('click', () => { helpModal.style.display = 'none'; }); helpModal.addEventListener('click', (e) => { if (e.target === helpModal) helpModal.style.display = 'none'; }); } }
    
    main();
});